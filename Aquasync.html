<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aquasync â€” Smart Water Bottle</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght=500;700&family=Inter:wght=400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Custom CSS Keyframes for Enhanced Animations */
    @keyframes neon-pulse {
      0%, 100% { box-shadow: 0 0 10px rgba(0, 191, 255, 0.5), 0 0 0px rgba(0, 191, 255, 0.2); }
      50% { box-shadow: 0 0 30px rgba(0, 191, 255, 0.9), 0 0 15px rgba(0, 191, 255, 0.5); }
    }
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Continuous pulse/glow animation for icons */
    @keyframes icon-pulse {
      0%, 100% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 1px rgba(0, 191, 255, 0.4)); }
      50% { transform: translateY(-2px) scale(1.05); filter: drop-shadow(0 0 8px rgba(0, 191, 255, 0.8)); }
    }

    .animate-neon-pulse { animation: neon-pulse 3s infinite alternate ease-in-out; }
    .animate-fade-slide-up { animation: fadeSlideUp 1s ease-out forwards; }
    .animate-icon-pulse { animation: icon-pulse 2s infinite alternate ease-in-out; }
    
    /* Background grid effect for a subtle high-tech look */
    .hero {
      background-image: 
        radial-gradient(circle at center, rgba(0, 31, 63, 0.8) 0%, rgba(0, 8, 20, 1) 100%),
        repeating-linear-gradient(0deg, #00bfff08, #00bfff08 1px, transparent 1px, transparent 50px),
        repeating-linear-gradient(90deg, #00bfff08, #00bfff08 1px, transparent 1px, transparent 50px);
    }

  </style>

  <script>
    // Tailwind Configuration to use the custom fonts and animations
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'cyber-bg': '#0a0f1c',
            'cyber-accent': '#00bfff',
            'cyber-muted': '#7a8ca5',
            'cyber-card': '#0f1e3c',
            'cyber-dark': '#000814',
          },
          fontFamily: {
            'orbitron': ['Orbitron', 'sans-serif'],
            'inter': ['Inter', 'sans-serif'],
          },
          borderRadius: {
            'xl': '12px',
          },
          animation: {
            'neon-pulse': 'neon-pulse 3s infinite alternate ease-in-out',
            'fade-slide-up': 'fadeSlideUp 1s ease-out forwards',
            'icon-pulse': 'icon-pulse 2s infinite alternate ease-in-out',
          },
        }
      }
    }
  </script>
</head>
<body class="bg-cyber-bg text-white min-h-screen font-inter">

  <header class="sticky top-0 z-20 p-4 md:px-10 flex justify-between items-center bg-gray-900/90 backdrop-blur-sm shadow-xl shadow-cyber-accent/10">
    <div class="font-orbitron text-2xl font-bold text-cyber-accent transition hover:text-cyan-300">Aquasync</div>
    <nav class="space-x-4">
      <a href="#landing-view" onclick="showView('landing-view')" class="text-white hover:text-cyber-accent transition duration-300 font-semibold text-sm md:text-base">Home</a>
      <a href="#features" class="text-white hover:text-cyber-accent transition duration-300 font-semibold text-sm md:text-base">Features</a>
      <a href="#shop" onclick="showView('order-page')" class="text-white hover:text-cyber-accent transition duration-300 font-semibold text-sm md:text-base">Order</a>
    </nav>
  </header>

  <main class="min-h-screen">
    <div id="landing-view" class="transition-opacity duration-700 ease-in">

      <section class="hero flex flex-col items-center text-center pt-28 pb-12 px-4 relative overflow-hidden">
        <h1 class="text-5xl md:text-7xl font-orbitron mb-4 text-cyber-accent drop-shadow-2xl shadow-cyber-accent/50 animate-fade-slide-up" style="animation-delay: 0.1s;">
          Aquasync
        </h1>
        <p class="text-lg max-w-xl text-blue-200/80 mt-4 animate-fade-slide-up" style="animation-delay: 0.3s;">
          Hydration Meets Innovation. The Smart Water Bottle That Thinks for You.
        </p>
        
        <div class="mt-12 mb-8 p-4 bg-gray-900/50 rounded-2xl shadow-2xl animate-neon-pulse border border-cyber-accent/30 animate-fade-slide-up" style="animation-delay: 0.5s;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 200" class="w-48 md:w-64 h-auto mx-auto drop-shadow-lg transition-transform duration-500 hover:scale-105">
                <defs>
                    <linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#00bfff;stop-opacity:0.8" />
                        <stop offset="100%" style="stop-color:#003c73;stop-opacity:0.9" />
                    </linearGradient>
                </defs>
                
                <rect x="25" y="10" width="50" height="180" rx="15" fill="#1f2937" stroke="#374151" stroke-width="1.5"/>
                
                <rect x="28" y="70" width="44" height="117" rx="12" fill="url(#waterGradient)"/>
                
                <rect x="25" y="0" width="50" height="15" rx="10" fill="#9ca3af"/>
                <rect x="30" y="5" width="40" height="5" rx="2" fill="#4b5563"/>

                <rect x="35" y="30" width="30" height="15" rx="3" fill="#000"/>
                <text x="50" y="42" font-family="Orbitron, sans-serif" font-size="8" fill="#00bfff" text-anchor="middle" font-weight="bold" class="drop-shadow-lg">SYNC</text>
                
                <rect x="25" y="55" width="50" height="2" fill="#00bfff" class="shadow-lg shadow-cyan-400/50"/>
            </svg>
        </div>
        <p class="text-sm text-cyber-muted italic animate-fade-slide-up" style="animation-delay: 0.7s;">â€” Available in Midnight Blue and Cyber Teal â€”</p>
      </section>

      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 p-10 md:p-16 bg-gray-900/50 border-t border-b border-cyan-500/10" id="features">
        <div class="bg-cyber-card p-6 rounded-xl shadow-lg shadow-cyber-accent/10 transition duration-300 transform hover:scale-[1.03] hover:shadow-cyan-500/30 border border-transparent hover:border-cyber-accent/50 animate-fade-slide-up" style="animation-delay: 0.8s;">
          <svg class="w-8 h-8 mx-auto mb-3 text-cyan-400 animate-icon-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <h3 class="text-cyber-accent text-xl font-semibold mb-2">Auto Tracking</h3>
          <p class="text-sm text-gray-400">Monitors your hydration levels and reminds you when to drink.</p>
        </div>
        <div class="bg-cyber-card p-6 rounded-xl shadow-lg shadow-cyber-accent/10 transition duration-300 transform hover:scale-[1.03] hover:shadow-cyan-500/30 border border-transparent hover:border-cyber-accent/50 animate-fade-slide-up" style="animation-delay: 0.9s;">
          <svg class="w-8 h-8 mx-auto mb-3 text-cyan-400 animate-icon-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.16 6.574 5 8.32 5 11v3.159c0 .538-.214 1.055-.595 1.436L3 17h5m5-5v.01"></path></svg>
          <h3 class="text-cyber-accent text-xl font-semibold mb-2">Smart Alerts</h3>
          <p class="text-sm text-gray-400">Get notified when you're falling behind on your hydration goals.</p>
        </div>
        <div class="bg-cyber-card p-6 rounded-xl shadow-lg shadow-cyber-accent/10 transition duration-300 transform hover:scale-[1.03] hover:shadow-cyan-500/30 border border-transparent hover:border-cyber-accent/50 animate-fade-slide-up" style="animation-delay: 1.0s;">
          <svg class="w-8 h-8 mx-auto mb-3 text-cyan-400 animate-icon-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          <h3 class="text-cyber-accent text-xl font-semibold mb-2">Thermal Control</h3>
          <p class="text-sm text-gray-400">Keeps your drink at the perfect temperature all day long.</p>
        </div>
        <div class="bg-cyber-card p-6 rounded-xl shadow-lg shadow-cyber-accent/10 transition duration-300 transform hover:scale-[1.03] hover:shadow-cyan-500/30 border border-transparent hover:border-cyber-accent/50 animate-fade-slide-up" style="animation-delay: 1.1s;">
          <svg class="w-8 h-8 mx-auto mb-3 text-cyan-400 animate-icon-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          <h3 class="text-cyber-accent text-xl font-semibold mb-2">Rechargeable</h3>
          <p class="text-sm text-gray-400">Long-lasting battery with USB-C fast charging.</p>
        </div>
        <div class="bg-cyber-card p-6 rounded-xl shadow-lg shadow-cyber-accent/10 transition duration-300 transform hover:scale-[1.03] hover:shadow-cyan-500/30 border border-transparent hover:border-cyber-accent/50 animate-fade-slide-up" style="animation-delay: 1.2s;">
          <svg class="w-8 h-8 mx-auto mb-3 text-cyan-400 animate-icon-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0013.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-12h4m-4 4h4m-4 4h4"/></svg>
          <h3 class="text-cyber-accent text-xl font-semibold mb-2">App Integration</h3>
          <p class="text-sm text-gray-400">Sync with your favorite health apps for full hydration analytics.</p>
        </div>
      </section>

      <section class="py-20 px-4 text-center bg-gradient-to-tr from-cyan-900/30 to-cyber-bg">
        <h2 class="text-4xl md:text-5xl font-bold mb-8 text-cyber-accent animate-fade-slide-up">Ready to Drink Smarter with Aquasync?</h2>
        <button onclick="showView('order-page')" class="bg-cyber-accent text-gray-950 font-bold py-3 px-10 rounded-full shadow-xl shadow-cyan-500/50 hover:bg-cyan-300 transition duration-300 transform hover:scale-105 animate-fade-slide-up" style="animation-delay: 0.2s;">
          SHOP NOW
        </button>
      </section>

    </div>

    <div id="order-page" class="hidden transition-opacity duration-700 ease-in py-20 px-4">
      <div class="max-w-4xl mx-auto bg-gray-900/70 p-6 md:p-12 rounded-2xl shadow-2xl shadow-cyan-500/20 border border-cyan-500/10">
        <h2 class="text-4xl font-orbitron text-center mb-10 text-cyber-accent animate-fade-slide-up">
          Secure Your Aquasync Pro
        </h2>
        
        <div class="flex flex-col lg:flex-row gap-10">
          <div class="lg:w-1/2">
            <div class="w-full h-auto mb-6 animate-neon-pulse" style="animation-duration: 4s;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 200" class="w-full max-w-xs h-auto mx-auto drop-shadow-lg">
                    <defs>
                        <linearGradient id="waterGradientOrder" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#00bfff;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#003c73;stop-opacity:0.9" />
                        </linearGradient>
                    </defs>

                    <rect x="25" y="10" width="50" height="180" rx="15" fill="#1f2937" stroke="#374151" stroke-width="1.5"/>
                    
                    <rect x="28" y="70" width="44" height="117" rx="12" fill="url(#waterGradientOrder)"/>
                    
                    <rect x="25" y="0" width="50" height="15" rx="10" fill="#9ca3af"/>
                    <rect x="30" y="5" width="40" height="5" rx="2" fill="#4b5563"/>

                    <rect x="35" y="30" width="30" height="15" rx="3" fill="#000"/>
                    <text x="50" y="42" font-family="Orbitron, sans-serif" font-size="8" fill="#00bfff" text-anchor="middle" font-weight="bold" class="drop-shadow-lg">SYNC</text>
                    
                    <rect x="25" y="55" width="50" height="2" fill="#00bfff" class="shadow-lg shadow-cyan-400/50"/>
                </svg>
            </div>
            <h3 class="text-3xl font-bold text-white mb-2">Aquasync Pro</h3>
            <p class="text-2xl font-orbitron text-cyan-400 mb-6">$149.99 USD</p>
            <ul class="text-sm text-cyber-muted space-y-2 list-disc list-inside">
              <li>Capacity: 24 oz (710 ml)</li>
              <li>Material: Vacuum-insulated stainless steel</li>
              <li>Battery Life: Up to 15 days</li>
              <li>Compatibility: iOS and Android via companion app</li>
            </ul>
          </div>

          <div class="lg:w-1/2">
            <div class="mb-8 p-4 border border-blue-500/30 rounded-lg bg-cyber-card shadow-lg">
                <h4 class="text-xl font-semibold text-cyan-300 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.16 6.574 5 8.32 5 11v3.159c0 .538-.214 1.055-.595 1.436L3 17h5m5-5v.01"></path></svg>
                    Smart Notifications
                </h4>
                <p class="text-xs text-gray-400 mb-3">Enable browser notifications for location-based deals and hydration reminders.</p>
                <div class="space-y-2">
                    <button id="notify-button" onclick="requestNotificationPermission()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                        Enable Notifications
                    </button>
                    <button id="geo-monitor-button" onclick="toggleGeoMonitoring()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                        Start Outlet Proximity Alert
                    </button>
                    <p id="geo-status" class="text-center text-xs pt-1 text-cyber-muted">Status: Monitoring Off</p>
                </div>
            </div>


            <form id="order-form" onsubmit="handleOrder(event)" class="space-y-6">
              <div>
                <label for="color" class="block text-sm font-medium text-cyan-300 mb-1">Color</label>
                <select id="color" required class="w-full p-3 rounded-lg bg-cyber-card border border-cyan-500/30 text-white focus:ring-cyan-500 focus:border-cyan-500">
                  <option value="midnight-blue">Midnight Blue</option>
                  <option value="cyber-teal">Cyber Teal</option>
                </select>
              </div>

              <div>
                <label for="quantity" class="block text-sm font-medium text-cyan-300 mb-1">Quantity</label>
                <input type="number" id="quantity" value="1" min="1" required class="w-full p-3 rounded-lg bg-cyber-card border border-cyan-500/30 text-white focus:ring-cyan-500 focus:border-cyan-500" />
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-cyan-300 mb-1">Email Address</label>
                <input type="email" id="email" required placeholder="name@example.com" class="w-full p-3 rounded-lg bg-cyber-card border border-cyan-500/30 text-white focus:ring-cyan-500 focus:border-cyan-500" />
              </div>

              <div>
                <label for="location" class="block text-sm font-medium text-cyan-300 mb-1">Shipping Zone (Dynamically Updated)</label>
                <select id="location" required disabled class="w-full p-3 rounded-lg bg-cyber-card border border-cyan-500/30 text-white focus:ring-cyan-500 focus:border-cyan-500">
                  <option value="detecting">Detecting Location...</option>
                </select>
              </div>

              <div class="pt-4">
                <button type="submit" class="w-full bg-cyber-accent text-gray-950 font-bold py-3 rounded-xl shadow-xl shadow-cyan-500/50 hover:bg-cyan-300 transition duration-300 transform hover:scale-[1.01]">
                  PLACE ORDER
                </button>
                <p id="order-message" class="mt-4 text-center text-sm font-semibold text-green-400 hidden"></p>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="p-6 text-center bg-gray-900 text-cyber-muted text-sm border-t border-cyan-500/10" id="contact">
    &copy; 2025 Aquasync. All rights reserved.
  </footer>

  <script type="module">
    // Firebase Imports for structure
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    // Global variables (mocked/provided by canvas environment)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let auth;
    let userId = null;

    // --- Geofencing State ---
    let notificationAllowed = false;
    let isMonitoring = false;
    let isInOutletRadius = false;
    let watchId = null; // Store the ID returned by watchPosition
    let closestOutlet = null; // Store the dynamically calculated closest outlet

    // Mock Aquasync Outlet Locations in India
    const AQUASYNC_OUTLETS = [
        { name: "Bangalore Outlet", lat: 12.9716, lon: 77.5946 },
        { name: "Mumbai Outlet", lat: 19.0760, lon: 72.8777 },
        { name: "New Delhi Outlet", lat: 28.6139, lon: 77.2090 },
        { name: "Goa Outlet (Panaji)", lat: 15.4989, lon: 73.8278 },
        { name: "Hyderabad Outlet", lat: 17.3850, lon: 78.4867 },
        { name: "Kochi Outlet", lat: 9.9312, lon: 76.2673 },
    ];
    
    const OUTLET_RADIUS_M = 500; // 500 meters radius

    // 1. Initialize Firebase and Auth
    if (Object.keys(firebaseConfig).length > 0) {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            
            // Set up authentication state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                }
            });

            async function authenticateUser() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth failed:", error);
                }
            }
            authenticateUser();

        } catch (e) {
            console.error("Firebase initialization error:", e);
        }
    }


    // 2. View Switching Logic (Unchanged)
    const landingView = document.getElementById('landing-view');
    const orderPage = document.getElementById('order-page');

    window.showView = (viewId) => {
        if (viewId === 'order-page') {
            landingView.classList.add('hidden', 'opacity-0');
            orderPage.classList.remove('hidden');
            setTimeout(() => orderPage.classList.remove('opacity-0'), 10);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // New: Attempt to set shipping zone when showing the order form
            detectAndSetShippingZone(); 
        } else {
            orderPage.classList.add('hidden', 'opacity-0');
            landingView.classList.remove('hidden');
            setTimeout(() => landingView.classList.remove('opacity-0'), 10);
            document.getElementById('features')?.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // 3. Simple Order Handler (Minor change for dynamic location text)
    window.handleOrder = (event) => {
        event.preventDefault();
        
        const color = document.getElementById('color').value;
        const quantity = document.getElementById('quantity').value;
        const email = document.getElementById('email').value;
        // Use the text from the closest outlet detection if available, otherwise fallback
        const locationElement = document.getElementById('location');
        const locationText = closestOutlet ? closestOutlet.name : locationElement.options[locationElement.selectedIndex].text;
        const messageElement = document.getElementById('order-message');

        console.log(`Order Placed (Mock): Color=${color}, Qty=${quantity}, Email=${email}, Location=${locationText}, UserID=${userId || 'N/A'}`);

        messageElement.textContent = `Order for ${quantity} x ${color} Aquasync Pro (shipping to ${locationText}) placed successfully!`;
        messageElement.classList.remove('hidden');

        // Optionally, reset form after successful mock submission
        setTimeout(() => {
            messageElement.classList.add('hidden');
            document.getElementById('order-form').reset();
            document.getElementById('quantity').value = 1; // Ensure quantity resets correctly
        }, 3000);
    }


    // --- 4. Location and Geofencing Functions (MODIFIED) ---

    /**
     * Calculates the distance between two lat/lon points (Haversine formula).
     * @param {number} lat1 
     * @param {number} lon1 
     * @param {number} lat2 
     * @param {number} lon2 
     * @returns {number} Distance in meters
     */
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth radius in metres
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c; // in meters
    }
    
    /**
     * Finds the closest outlet to the user's current position.
     * @param {number} userLat 
     * @param {number} userLon 
     * @returns {object} The closest outlet object with distance property.
     */
    function findClosestOutlet(userLat, userLon) {
        let closest = null;
        let minDistance = Infinity;

        AQUASYNC_OUTLETS.forEach(outlet => {
            const distance = calculateDistance(userLat, userLon, outlet.lat, outlet.lon);
            if (distance < minDistance) {
                minDistance = distance;
                closest = { ...outlet, distance: distance };
            }
        });
        return closest;
    }

    /**
     * Sets the shipping zone dropdown based on the user's geolocation.
     */
    function detectAndSetShippingZone() {
        const selectElement = document.getElementById('location');
        selectElement.innerHTML = '<option value="detecting">Detecting Location...</option>';
        selectElement.disabled = true;

        if (!('geolocation' in navigator)) {
            selectElement.innerHTML = '<option value="not-supported">Geolocation Not Supported</option>';
            selectElement.disabled = false;
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                closestOutlet = findClosestOutlet(userLat, userLon);

                selectElement.innerHTML = '';
                selectElement.disabled = false;
                
                // Add the detected closest location as the primary option
                const detectedOption = document.createElement('option');
                detectedOption.value = closestOutlet.name.toLowerCase().replace(/\s/g, '-');
                detectedOption.textContent = `${closestOutlet.name} (Detected)`;
                selectElement.appendChild(detectedOption);

                // Add all other locations
                AQUASYNC_OUTLETS.forEach(outlet => {
                    if (outlet.name !== closestOutlet.name) {
                        const option = document.createElement('option');
                        option.value = outlet.name.toLowerCase().replace(/\s/g, '-');
                        option.textContent = outlet.name;
                        selectElement.appendChild(option);
                    }
                });

            },
            (error) => {
                console.error("Location detection failed:", error);
                selectElement.innerHTML = '<option value="default">Location Detection Failed</option>';
                // Populate with default options if detection fails
                AQUASYNC_OUTLETS.forEach(outlet => {
                    const option = document.createElement('option');
                    option.value = outlet.name.toLowerCase().replace(/\s/g, '-');
                    option.textContent = outlet.name;
                    selectElement.appendChild(option);
                });
                selectElement.disabled = false;
            },
            { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
        );
    }
    
    /**
     * Geo-fencing check and notification trigger.
     */
    function checkOutletProximity(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const geoStatus = document.getElementById('geo-status');
        const button = document.getElementById('geo-monitor-button');

        // Find the closest outlet continuously while monitoring
        closestOutlet = findClosestOutlet(userLat, userLon);
        
        if (!closestOutlet) {
             geoStatus.textContent = "Status: Error finding outlets.";
             return;
        }

        const distance = closestOutlet.distance;
        
        button.textContent = `Monitoring: ${closestOutlet.name}`;
        geoStatus.textContent = `Status: Monitoring Active. Distance to ${closestOutlet.name}: ${distance.toFixed(0)}m`;

        const isNowInRadius = distance <= OUTLET_RADIUS_M;

        if (isNowInRadius && !isInOutletRadius) {
            // User just entered the radius
            if (notificationAllowed) {
                window.showCustomNotification(
                    `ðŸŽ‰ Welcome to ${closestOutlet.name}!`, 
                    "You are within 500m of our store. Show this notification for 10% off accessories!"
                );
            }
            geoStatus.classList.replace('text-cyber-muted', 'text-yellow-400');
            isInOutletRadius = true;
        } else if (!isNowInRadius && isInOutletRadius) {
            // User just left the radius
            geoStatus.classList.replace('text-yellow-400', 'text-cyber-muted');
            isInOutletRadius = false;
        }
    }

    /**
     * Starts continuous location monitoring.
     */
    function startGeoMonitoring() {
        const button = document.getElementById('geo-monitor-button');
        const geoStatus = document.getElementById('geo-status');

        if (isMonitoring || !('geolocation' in navigator)) {
            geoStatus.textContent = "Geolocation Not Supported";
            button.disabled = true;
            return;
        }

        button.textContent = "Requesting Location...";
        button.classList.replace('bg-indigo-600', 'bg-yellow-600');
        
        const options = {
            enableHighAccuracy: true,
            maximumAge: 10000, 
            timeout: 5000 
        };

        // Start watching the position
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                isMonitoring = true;
                button.classList.replace('bg-yellow-600', 'bg-green-600');
                button.classList.remove('hover:bg-indigo-700'); // Remove hover effect when active
                button.textContent = `Proximity Monitoring ON`;
                checkOutletProximity(position);
            },
            (error) => {
                stopGeoMonitoring(error.code);
                geoStatus.textContent = `Status: Geo Error (${error.code}). Please enable location.`;
                console.error("Geolocation error:", error);
            },
            options
        );
        isMonitoring = true;
    }

    /**
     * Stops continuous location monitoring.
     * @param {number} errorCode - Optional error code to show stop reason
     */
    function stopGeoMonitoring(errorCode) {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        isMonitoring = false;
        isInOutletRadius = false;
        
        const button = document.getElementById('geo-monitor-button');
        const geoStatus = document.getElementById('geo-status');

        button.textContent = "Start Outlet Proximity Alert";
        button.classList.replace('bg-green-600', 'bg-indigo-600');
        button.classList.replace('bg-red-600', 'bg-indigo-600');
        button.classList.add('hover:bg-indigo-700');

        if (errorCode) {
            geoStatus.textContent = `Status: Monitoring Stopped (Error: ${errorCode})`;
        } else {
            geoStatus.textContent = "Status: Monitoring Off (Manual Stop)";
        }
        geoStatus.classList.replace('text-yellow-400', 'text-cyber-muted');
    }

    /**
     * Toggles geo-monitoring on and off.
     */
    window.toggleGeoMonitoring = () => {
        if (isMonitoring) {
            stopGeoMonitoring();
        } else {
            startGeoMonitoring();
        }
    }


    // --- 5. Notification Functions (Unchanged, but now used by dynamic check) ---

    window.showCustomNotification = (title, body) => {
        if (Notification.permission === 'granted') {
            new Notification(title, {
                body: body,
                icon: 'https://placehold.co/128x128/00bfff/000000?text=Aqua',
                vibrate: [200, 100, 200]
            });
        }
    }

    window.requestNotificationPermission = async () => {
        const button = document.getElementById('notify-button');
        if (!('Notification' in window)) {
            button.textContent = "Notifications Not Supported";
            button.disabled = true;
            return;
        }

        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            notificationAllowed = true;
            button.textContent = "Notifications Enabled";
            button.classList.replace('bg-blue-600', 'bg-green-600');
            window.showCustomNotification("Aquasync Notifications", "You'll receive smart reminders and outlet alerts.");
        } else {
            notificationAllowed = false;
            button.textContent = "Permission Denied";
            button.classList.replace('bg-blue-600', 'bg-red-600');
        }
    }


    /**
     * Initializes the UI elements.
     */
    function initializeUI() {
        // Since we are now using detectAndSetShippingZone when opening the order page,
        // we only initialize the geo status text on load.
        const button = document.getElementById('geo-monitor-button');
        const status = document.getElementById('geo-status');
        button.textContent = "Start Outlet Proximity Alert";
        status.textContent = "Status: Monitoring Off";
        
        // Populate the location dropdown with "Detecting" initially on load
        document.getElementById('location').innerHTML = '<option value="detecting">Detecting Location...</option>';
    }
    
    // --- 0. Initialization after all functions are defined ---
    document.addEventListener('DOMContentLoaded', initializeUI);
  </script>
</body>
</html>